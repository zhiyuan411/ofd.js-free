<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OFDæ–‡ä»¶è‡ªåŠ¨æµ‹è¯•</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- OFD.js -->
  <script src="./lib/ofd.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            accent: '#0ea5e9',
            neutral: '#f1f5f9',
            'neutral-dark': '#334155',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .bg-gradient-blue {
        background: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center space-x-2">
        <i class="fa fa-file-text-o text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-gray-800">OFDæ–‡ä»¶è‡ªåŠ¨æµ‹è¯•</h1>
      </div>
    </div>
  </header>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <main class="container mx-auto px-4 py-6">
    <!-- æµ‹è¯•è¿›åº¦ -->
    <div class="bg-white rounded-lg shadow-card p-4 mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">æµ‹è¯•è¿›åº¦</h2>
      <div class="flex items-center space-x-4">
        <div class="flex-1">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        <span id="progress-text" class="text-sm text-gray-600">å‡†å¤‡ä¸­...</span>
      </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="results-container">
      <!-- ç»“æœå°†åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </main>

  <!-- åº•éƒ¨ä¿¡æ¯ -->
  <footer class="bg-white shadow-sm mt-auto">
    <div class="container mx-auto px-4 py-4 text-center text-sm text-gray-500">
      <p>Â© 2025 OFDæ–‡ä»¶è‡ªåŠ¨æµ‹è¯• | ä½¿ç”¨ <a href="https://github.com/DLTech21/ofd.js" target="_blank" class="text-primary hover:underline">ofd.js</a> æ„å»º</p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // æ ·æœ¬æ–‡ä»¶åˆ—è¡¨
      const sampleFiles = [
        { name: '2.ofd', path: './public/2.ofd' },
        { name: '999.ofd', path: './public/999.ofd' },
        { name: 'h.ofd', path: './public/h.ofd' },
        { name: 'n.ofd', path: './public/n.ofd' }
      ];

      // å…¨å±€å˜é‡
      const resultsContainer = document.getElementById('results-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      
      let completedTests = 0;
      const totalTests = sampleFiles.length;

      // åˆå§‹åŒ–
      initAutoTest();

      // åˆå§‹åŒ–è‡ªåŠ¨æµ‹è¯•
      function initAutoTest() {
        console.log('ğŸš€ å¼€å§‹è‡ªåŠ¨æµ‹è¯•OFDæ–‡ä»¶...');
        updateProgress(0, `å¼€å§‹æµ‹è¯• ${totalTests} ä¸ªæ–‡ä»¶`);
        
        // é€ä¸ªæµ‹è¯•æ–‡ä»¶
        sampleFiles.forEach((fileInfo, index) => {
          setTimeout(() => {
            testOfdFile(fileInfo, index);
          }, index * 1000); // æ¯ä¸ªæ–‡ä»¶é—´éš”1ç§’å¼€å§‹æµ‹è¯•
        });
      }

      // æµ‹è¯•å•ä¸ªOFDæ–‡ä»¶
      function testOfdFile(fileInfo, index) {
        console.log(`ğŸ” æ­£åœ¨æµ‹è¯•æ–‡ä»¶: ${fileInfo.name}`);
        updateProgress(completedTests, `æ­£åœ¨æµ‹è¯•: ${fileInfo.name}`);

        // åˆ›å»ºç»“æœå¡ç‰‡
        const resultCard = createResultCard(fileInfo, index);
        resultsContainer.appendChild(resultCard);

        // è·å–æ–‡ä»¶
        fetch(fileInfo.path)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.arrayBuffer();
          })
          .then(arrayBuffer => {
            // ç¡®ä¿ofdåº“å·²æ­£ç¡®åŠ è½½
            if (!window.ofd || typeof window.ofd.parseOfdDocument !== 'function') {
              throw new Error('ofd.jsåº“æœªæ­£ç¡®åŠ è½½');
            }

            console.log(`âœ… æˆåŠŸè·å–æ–‡ä»¶: ${fileInfo.name}`, arrayBuffer.byteLength, 'bytes');

            // è§£æOFDæ–‡ä»¶
            window.ofd.parseOfdDocument({
              ofd: arrayBuffer,
              success(parsedDocs) {
                try {
                  console.log(`âœ… ${fileInfo.name} è§£ææˆåŠŸ`, parsedDocs);
                  
                  // è·å–ç¬¬ä¸€ä¸ªæ–‡æ¡£å¯¹è±¡
                  const ofdDoc = parsedDocs[0];
                  if (!ofdDoc || !ofdDoc.pages) {
                    throw new Error('è§£æçš„æ–‡æ¡£å¯¹è±¡æ— æ•ˆ');
                  }
                  
                  // æ¸²æŸ“æ–‡æ¡£ - æ­£ç¡®ä¼ é€’è§£æåçš„æ–‡æ¡£å¯¹è±¡
                  const divs = window.ofd.renderOfd(400, ofdDoc); // å®½åº¦400px, ä¼ å…¥æ–‡æ¡£å¯¹è±¡
                  
                  if (!divs || divs.length === 0) {
                    throw new Error('æœªç”Ÿæˆä»»ä½•é¡µé¢');
                  }

                  // æ›´æ–°ç»“æœå¡ç‰‡
                  updateResultCard(resultCard, 'success', fileInfo, divs);
                  
                  // æ›´æ–°è¿›åº¦
                  completedTests++;
                  updateProgress(completedTests, `å·²å®Œæˆ ${completedTests}/${totalTests} ä¸ªæ–‡ä»¶`);
                  
                } catch (renderError) {
                  console.error(`âŒ ${fileInfo.name} æ¸²æŸ“å¤±è´¥:`, renderError);
                  updateResultCard(resultCard, 'error', fileInfo, null, `æ¸²æŸ“å¤±è´¥: ${renderError.message}`);
                  
                  completedTests++;
                  updateProgress(completedTests, `å·²å®Œæˆ ${completedTests}/${totalTests} ä¸ªæ–‡ä»¶`);
                }
              },
              fail(error) {
                console.error(`âŒ ${fileInfo.name} è§£æå¤±è´¥:`, error);
                updateResultCard(resultCard, 'error', fileInfo, null, `è§£æå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                
                completedTests++;
                updateProgress(completedTests, `å·²å®Œæˆ ${completedTests}/${totalTests} ä¸ªæ–‡ä»¶`);
              }
            });
          })
          .catch(fetchError => {
            console.error(`âŒ è·å–æ–‡ä»¶ ${fileInfo.name} å¤±è´¥:`, fetchError);
            updateResultCard(resultCard, 'error', fileInfo, null, `è·å–å¤±è´¥: ${fetchError.message}`);
            
            completedTests++;
            updateProgress(completedTests, `å·²å®Œæˆ ${completedTests}/${totalTests} ä¸ªæ–‡ä»¶`);
          });
      }

      // åˆ›å»ºç»“æœå¡ç‰‡
      function createResultCard(fileInfo, index) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow-card p-4 transition-all-300';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-gray-800 truncate">${fileInfo.name}</h3>
            <div class="flex items-center">
              <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse mr-2"></div>
              <span class="text-sm text-yellow-600">æµ‹è¯•ä¸­</span>
            </div>
          </div>
          <div class="text-sm text-gray-600 mb-3">
            <div>è·¯å¾„: ${fileInfo.path}</div>
            <div>çŠ¶æ€: å‡†å¤‡æµ‹è¯•...</div>
          </div>
          <div class="border-t pt-3">
            <div class="text-center text-gray-500">
              <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
              <p>æ­£åœ¨åŠ è½½å’Œè§£ææ–‡ä»¶...</p>
            </div>
          </div>
        `;
        return card;
      }

      // æ›´æ–°ç»“æœå¡ç‰‡
      function updateResultCard(card, status, fileInfo, divs = null, errorMessage = '') {
        const statusBadge = card.querySelector('div.flex.items-center > div:first-child');
        const statusText = card.querySelector('div.flex.items-center span');
        const infoDiv = card.querySelector('div.text-sm.text-gray-600');
        const contentDiv = card.querySelector('div.border-t');

        if (status === 'success') {
          // æˆåŠŸçŠ¶æ€
          statusBadge.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
          statusBadge.style.animation = 'none';
          statusText.className = 'text-sm text-green-600';
          statusText.textContent = 'æµ‹è¯•æˆåŠŸ';
          
          infoDiv.innerHTML = `
            <div>è·¯å¾„: ${fileInfo.path}</div>
            <div>çŠ¶æ€: è§£ææˆåŠŸ</div>
            <div>é¡µé¢æ•°: ${divs.length} é¡µ</div>
          `;
          
          // æ˜¾ç¤ºæ¸²æŸ“å†…å®¹
          contentDiv.innerHTML = `
            <div class="text-sm text-gray-600 mb-2">æ¸²æŸ“é¢„è§ˆ:</div>
            <div class="max-h-60 overflow-y-auto scrollbar-thin border rounded p-2 bg-gray-50">
              ${divs.map(div => div.outerHTML).join('')}
            </div>
          `;
          
          // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
          const renderedDivs = contentDiv.querySelectorAll('div');
          renderedDivs.forEach(renderedDiv => {
            renderedDiv.style.transform = 'scale(0.8)';
            renderedDiv.style.transformOrigin = 'top left';
            renderedDiv.style.marginBottom = '10px';
          });

        } else if (status === 'error') {
          // é”™è¯¯çŠ¶æ€
          statusBadge.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
          statusBadge.style.animation = 'none';
          statusText.className = 'text-sm text-red-600';
          statusText.textContent = 'æµ‹è¯•å¤±è´¥';
          
          infoDiv.innerHTML = `
            <div>è·¯å¾„: ${fileInfo.path}</div>
            <div>çŠ¶æ€: æµ‹è¯•å¤±è´¥</div>
          `;
          
          contentDiv.innerHTML = `
            <div class="text-center text-red-500">
              <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
              <p class="font-medium">æµ‹è¯•å¤±è´¥</p>
              <p class="text-sm mt-1">${errorMessage}</p>
            </div>
          `;
        }
      }

      // æ›´æ–°è¿›åº¦æ¡
      function updateProgress(completed, text) {
        const percentage = totalTests > 0 ? (completed / totalTests) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = text;
        
        // å®Œæˆæ‰€æœ‰æµ‹è¯•
        if (completed >= totalTests) {
          setTimeout(() => {
            progressText.textContent = `ğŸ‰ æµ‹è¯•å®Œæˆ! æˆåŠŸæµ‹è¯• ${completed} ä¸ªæ–‡ä»¶`;
            progressBar.className = 'bg-green-500 h-2.5 rounded-full transition-all duration-300';
          }, 500);
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆæ£€æŸ¥
      window.addEventListener('load', function() {
        if (!window.ofd) {
          console.error('âŒ ofd.jsåº“åŠ è½½å¤±è´¥');
          document.body.innerHTML = `
            <div class="min-h-screen flex items-center justify-center bg-red-50">
              <div class="text-center p-8 bg-white rounded-lg shadow-lg max-w-md">
                <i class="fa fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold text-gray-800 mb-2">åŠ è½½å¤±è´¥</h2>
                <p class="text-gray-600">æ— æ³•åŠ è½½ ofd.js åº“ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚</p>
                <p class="text-sm text-gray-500 mt-2">è¯·ç¡®ä¿ ./dist-manual-fixed-version/ofd.bundle-v3.js æ–‡ä»¶å­˜åœ¨</p>
              </div>
            </div>
          `;
        } else {
          console.log('âœ… ofd.jsåº“åŠ è½½æˆåŠŸ');
        }
      });
    });
  </script>
</body>
</html>
